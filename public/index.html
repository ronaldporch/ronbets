<!DOCTYPE html>
<html lang="en">
<head>
	<title>Casino Night</title>
	<link rel="stylesheet" type="text/css" href="bower_components/angular/angular-csp.css">
	<link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
</head>
<body ng-app="TestApp" ng-controller="TestController">
	<nav class="navbar navbar-default">
  		<div class="container-fluid">
    		<div class="navbar-header">
      		<a class="navbar-brand" href="#">
        		Casino Night ({{user}})
      		</a>
        </div>
      </div>
  </nav>
  <div class="alert alert-info marquee" role="alert">
    <marquee ng-show="currentBet.active">Next Match for <strong>{{currentBet.game}}</strong>: <strong>{{currentBet.players[0]}}</strong> vs <strong>{{currentBet.players[1]}}</strong></marquee>
    <marquee ng-hide="currentBet.active || currentBet.winner">Betting is over! <strong>Let's get it on!</strong></marquee>
    <marquee ng-show="currentBet.winner">This game's winner is: <strong>{{currentBet.players[currentBet.winner]}}!</strong></marquee>
  </div> 
	<div class="container-fluid">
    <div class="col-md-8">
      <div>
        <iframe src="http://player.twitch.tv/?channel=dada5714" id="screen" width="640" height="300" allowfullscreen></iframe>
      </div>
      <div class="row">
        {{currentBet.totals}}
        <div>Odds: {{currentBet.odds[0]}} : {{currentBet.odds[1]}}</div>
        <div class="col-md-12">
        <div class="alert alert-danger" role="alert">
          <p class="text-center time"><b>{{currentBet.timer.minute}}:<span ng-show="currentBet.remaining_time % 60 < 10">0</span>{{currentBet.remaining_time % 60}}</b></p>
        </div>
        </div>
        <div class="col-sm-6">
          <table class="table table-striped">
            <tr>
              <th class="">{{currentBet.players[0]}} 
                <button type="button" class="btn btn-default btn-sm text-right" ng-click="showBet1 = true" ng-show="currentBet.active">Bet</button>
                <form class="form-inline" ng-show="showBet1" ng-submit="closeBet(1)">
  <div class="form-group">
    <label class="sr-only" for="exampleInputAmount">Amount (in dollars)</label>
    <div class="input-group">
      <div class="input-group-addon">$</div>
      <input type="number" class="form-control" id="exampleInputAmount" max="{{user.money}}" min="0" placeholder="Amount" ng-model="player1Bet" required>
    </div>
  </div>
</form>
              </th>
            </tr>
            <tr ng-repeat="better in betters.player1">
              <td>${{better.bet}} <small>{{better.name}}<small></td>
            </tr>
          </table>
        </div>
        <div class="col-sm-6">
          <table class="table table-striped">
            <tr>
              <th class="align-center">{{currentBet.players[1]}}
                <button type="button" class="btn btn-default btn-sm text-right" ng-click="showBet2 = true" ng-show="currentBet.active">Bet</button>
                <form class="form-inline" ng-show="showBet2" ng-submit="closeBet(2)">
  <div class="form-group">
    <label class="sr-only" for="exampleInputAmount">Amount (in dollars)</label>
    <div class="input-group">
      <div class="input-group-addon">$</div>
      <input type="number" class="form-control" id="exampleInputAmount" placeholder="Amount" max="{{user.money}}" min="0" ng-model="player2Bet" required>
    </div>
  </div>
</form>
              </th>
            </tr>
            <tr ng-repeat="better in betters.player2">
              <td>${{better.bet}} <small>{{better.name}}<small></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <iframe frameborder="0" scrolling="no" src="http://twitch.tv/dada5714/chat?popout=" height="700" width="325">
    </div>
    </iframe>
	</div>
</body>
<script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
<script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
	var app = angular.module('TestApp', [])
	app.controller('TestController', ['$scope', '$interval', '$rootScope',function($scope, $interval, $rootScope){
    $scope.currentBet = {}

    $scope.startNewBetTimer = function(data){
      $scope.stopBetTimer();
      $scope.$apply(function(){
        $scope.currentBet = data;
        $scope.betters.player1 = [];
        $scope.betters.player2 = [];
      console.log($scope.currentBet.players)
      })
    }

    var server = "http://localhost:3000";
    server = "https://27f21bd7.ngrok.io"
    var socket = io.connect(server);

    socket.on('bettingClosed', function(data){
      $scope.$apply(function(){
        console.log("Closing Bets")
        $scope.currentBet.active = false;
      })
    })
    socket.on('currentBet', function(data){
      $scope.$apply(function(){
        $scope.currentBet = data
        console.log($scope.currentBet)
      })
      console.log("Hello")
      console.log(data)
    })
    socket.on('currentBets', function(data){
      $scope.$apply(function(){
        $scope.betters.player1 = [];
        $scope.betters.player2 =[];
        data.bets.forEach(function(value, index, ar){
          if(value.player_id == 1){
            var newBet = {
              name: value.username,
              bet: value.amount
            }
            $scope.betters.player1.push(newBet)
          }else{
            var newBet = {
              name: value.username,
              bet: value.amount
            }
            $scope.betters.player2.push(newBet)
          }
        })
      })
    })
    socket.on('matchClosed', function(data){
      $scope.$apply(function(){
        $scope.currentBet = data;
        socket.emit('askUserInfo', {user:2})
      })
    })
    socket.on('remaining_time', function(data){
      $scope.$apply(function(){
        $scope.currentBet.remaining_time = data.remaining_time;
      })
      console.log($scope.currentBet.remaining_time);
    })
    socket.on('startNewMatch', function(data){
      $scope.startNewBetTimer(data);
    })
    socket.on('updatedMoney', function(data){
      $scope.$apply(function(){
        $scope.user.money = data.money
        console.log("Money: ", $scope.user.money)
      })
    })
    socket.on('sendUserInfo', function(data){
      console.log(data)
      $scope.$apply(function(){
        var user = data.user.map(function(data){
        return {
          username: data.username,
          money: parseInt(data.money)
        }
      });
        $scope.user = user[0]
      })
      console.log($scope.user)
    })
    socket.emit('askUserInfo', {user:2})
  socket.on('news', function (data) {
    console.log(data.bets)
    var player = data.bets[0]['player_id'];
    var bets = data.bets.map(function(data){
      return {
        name: data.username,
        bet: data.amount
      }
    });
    console.log(bets)
    $scope.$apply(function(){
      switch(player){
      case "1":
        $scope.betters.player1 = bets;
        break;
      case "2":
        $scope.betters.player2 = bets;
        break;
    }
    })
  });

    $scope.stopBetTimer = function(){
      if(angular.isDefined(stop)){
        $scope.currentBet.active = false;
        $scope.showBet1 = false;
        $scope.showBet2 = false;
        $scope.totalBets = {
          player1: 0,
          player2: 0
        }
        $scope.betters.player1.forEach(function(value, index, ar){
          $scope.totalBets.player1 += parseInt(value.bet)
        })
        $scope.betters.player2.forEach(function(value, index, ar){
          $scope.totalBets.player2 += parseInt(value.bet)
        })
        console.log($scope.totalBets)
        $scope.odds = {};
        if($scope.totalBets.player1 > $scope.totalBets.player2){
          $scope.odds.player1 = Math.round(($scope.totalBets.player1 / $scope.totalBets.player2) * 100)/100
          $scope.odds.player2 = 1
        }else{
          $scope.odds.player2 = Math.round(($scope.totalBets.player1 / $scope.totalBets.player2) * 100)/100
          $scope.odds.player1 = 1
        }
        console.log($scope.odds)
      }
    }

    socket.on('updatedTotals', function(data){
      $scope.$apply(function(){
        $scope.currentBet.totals = data.totals
        $scope.currentBet.odds = data.odds
      })
    })

    $scope.closeBet = function(player){
      console.log("Player: ", player)
      if(player == 1){
        var betData = [2, $scope.player1Bet, $scope.currentBet.id, 1];
        console.log(betData)
        socket.emit('my other event', 
        { 
          betData: betData
        });
        $scope.showBet1 = false;
      }else{
        var betData = [2, $scope.player2Bet, $scope.currentBet.id, 2];
        console.log(betData)
        socket.emit('my other event', 
        { 
          betData: betData
        });
        $scope.showBet2 = false;
      }
      $scope.player1Bet = undefined;
      $scope.player2Bet = undefined;
    }
    $scope.betters = {}
	}])
</script>
<style type="text/css">
  .navbar {
    border-radius: 0;
  }
  .marquee {
    margin-top: -20px;
    border-radius: 0;
  }
  .time {
    font-size: 40px;
  }
</style>
</html>