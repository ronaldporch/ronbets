#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('testApp:server');
var http = require('http');
var pg = require('pg');
//var conString = "postgres://postgres:Blazeteam1@localhost/test"
var conString = process.env.DATABASE_URL
console.log(conString)
/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * Create HTTP server.
 */

var server = http.createServer(app);
var io = require('socket.io')(server);
var client = new pg.Client(conString);
client.connect();



var countDown = function(data){
  console.log("counting down")
  var queryString = "update test.matches set remaining_time = remaining_time - 1 where id = $1 returning remaining_time";
  client.query(queryString, [data.match.id], function(err, result){
    if(err){
      console.log(err);
    }else{
      data.socketIO.to(data.stream_name).emit('remaining_time', {remaining_time: result.rows[0]['remaining_time']})
      if(result.rows[0]['remaining_time'] == 0){
        console.log("Ending Betting")
          var queryString = "update test.matches set remaining_time = 0, betting = false where id = $1 returning *"
          client.query(queryString, [data.match.id], function(err, result){
            if(err){
              console.log(err)
            }else{
              data.socketIO.to(data.stream_name).emit('bettingClosed', result.rows[0])
            }
          })
        clearInterval(interval);
      }
    }
  })
}

var streamView = io
  .of('/stream')
  .on('connection', function(socket){
    socket.on('submitWinner', function(data){
      var queryString = "update test.matches set winner = $1, closed = true where id = $2 returning *";
      console.log('match id: ', data.currentMatch.id)
      client.query(queryString, [data.winner, data.currentMatch.id], function(err, result){
        if(err){
          console.log(err)
        }else{
          streamView.to(data.stream_name).emit('showWinner', result.rows[0])
          console.log(result.rows[0])
          var odds = ""
          if(data.winner == 1){
            odds = 2
          }else{
            odds = 1
          }
          var queryString = "update test.users set wallet = wallet + ((select amount from test.bets where match_id = $1 and player_id = $2 and user_id = test.users.id) * case when CAST((select players[$3] ->> 'odds' from test.matches where test.matches.id = $1) as integer) = 0 then 2 else (1 + CAST((select players[$3] ->> 'odds' from test.matches where test.matches.id = $1) as numeric)) end) from test.bets where match_id = $1 and player_id = $2 and user_id = test.users.id returning *";
          client.query(queryString, [data.currentMatch.id, data.winner, odds], function(err){
            if(err){
              console.log(err)
            }else{
              console.log(result.rows)
            }
          })
        }
      })
    })
    socket.on('disconnect', function(data){
      console.log('disconnected')
    })
    socket.on('getStreamInfo', function(data){
      socket.join(data.streamer)
      var queryString = "select * from test.users where username = $1"
      client.query(queryString, [data.streamer], function(err, result){
        if(err){
          console.log(err);
        }else{
          socket.emit('sendStreamInfo', result.rows[0])
        }
      })
    })
      socket.on('getUserInfo', function(data){
      var queryString = "select * from test.users where id = $1"
      client.query(queryString, [data.user], function(err, result){
        if(err){
          console.log(err);
        }else{
          socket.emit('sendUserInfo', result.rows[0])
        }
      })
    })
    socket.on('getConnection', function(data){
      socket.join(data.user.stream_name)
      console.log("Admin coming in")
      var queryString = "select * from test.matches where streamer_id = $1 order by id desc limit 1"
      client.query(queryString, [data.user.id], function(err, result){
        if(err){
          console.log(err)
        }else{
          socket.emit('latestMatch', result.rows[0])
        }
      })
    })
    socket.on('sendNewMatch', function(data){
      var queryString = "insert into test.matches (players, game_id, remaining_time, streamer_id) values ($1, $2, $3, $4) returning *"
      client.query(queryString, [data.players, 1, data.remaining_time, data.streamer_id], function(err, result){
        if(err){
          console.log(err)
        }else{
          var gameObject = {
            match: result.rows[0],
            socketIO: streamView,
            stream_name: data.stream_name
          }
          streamView.to(data.stream_name).emit('startNewMatch', result.rows[0])
          socket.emit('latestMatch', result.rows[0])
          if(typeof interval !== 'undefined'){
            clearInterval(interval);
          }
            data.socketIO = streamView
            interval = setInterval(countDown, 1000, gameObject);
          }
      })
    })
    socket.on('message', function(data){
      console.log(data.streamer)
      streamView.to(data.streamer).emit('checkMessage',{
        message: data.message,
        rooms: socket.rooms
      })
    })
    socket.on('sendBet', function(data){
      var queryString = "insert into test.bets (match_id, player_id, amount, user_id) values ($1, $2, $3, $4) returning *"
      client.query(queryString, [data.bet.match_id, data.bet.player, data.bet.amount, data.bet.user_id], function(err, result){
        if(err){
          console.log(err)
        }else{
          socket.emit('yourBet', result.rows[0])
          var queryString = "select * from test.bets where match_id = $1 order by id desc"
          client.query(queryString, [data.bet.match_id], function(err, result){
            if(err){
              console.log(err)
            }else{
              streamView.to(data.streamer.username).emit('currentBets', result.rows)
              var queryString = "update test.users set wallet = wallet - $1 where id = $2 returning *"
              client.query(queryString, [data.bet.amount, data.bet.user_id], function(err, result){
                if(err){
                  console.log(err)
                }else{
                  socket.emit('yourWallet', result.rows[0])
                }
              })
            }
          })
        }
      })
    })
    socket.on('getRecentMatch', function(data){
      console.log("Streamer: ", data.streamer)
      var queryString = "select * from test.matches where streamer_id = (select id from test.users where username = $1) order by test.matches.id desc limit 1";
      client.query(queryString, [data.streamer], function(err, result){
        if(err){
          console.log(err);
        }
        else{
          console.log(result.rows)
          if(result.rows.length > 0){
            socket.emit('sendRecentMatch', result.rows[0])
          var queryString = "select * from test.bets where match_id = $1 and user_id = $2 order by id desc"
          console.log(result.rows[0]['id'], data.user)
          client.query(queryString, [result.rows[0]['id'], data.user], function(err, result){
            if(err){
              console.log(err);
            }else{
              if(result.rows){
                console.log(result.rows[0])
                socket.emit('yourBet', result.rows[0])
              }else{

              }
            }
          })

          var queryString = "select * from test.bets where match_id = $1 order by id desc"
          client.query(queryString, [result.rows[0]['id']], function(err, result){
            if(err){
              console.log(err);
            }else{
              socket.emit('currentBets', result.rows)
            }
          })
          }
          console.log(result.rows)
        }
      })
    })
  })

/*var main = io.on('connection', function (socket) {
  console.log("Here")
    var queryString = "select * from test.match order by id desc";
    client.query(queryString, function(err, result){
      if(err){
        console.log(err)
      }
      else{
        console.log("here")
        socket.emit('currentBet', result.rows[0])
        var queryString = "select b.*, u.username from test.bets b join test.users u on b.user_id = u.id where match_id = $1"
        client.query(queryString, [result.rows[0]['id']], function(err, results){
          if(err){
            console.log(err)
          }else{
            socket.emit('currentBets', {"bets":results.rows})
          }
        })
      }
    })
    socket.on('submitWinner', function(data){
      console.log(data)
      var queryString = "update test.match set winner = $1, active = false where id = $2 returning *";
      client.query(queryString, [data.player, data.match_id], function(err, result){
        if(err){
          console.log(err);
        }else{
          var opponentOdds;
          if(data.player == 0){
            opponentOdds = 2;
          }else{
            opponentOdds = 1;
          }
          var queryString = "update test.users set money = money + ((select sum(b.amount) from test.bets b where b.match_id = $1 and b.user_id = test.users.id and b.player_id = $2) * case when (select odds[$3] from test.match m where m.id = $1) = 0 then 2 else (2 + (select odds[$3] from test.match m where m.id = $1) - 1.00) end)"
          client.query(queryString, [data.match_id, data.player + 1, opponentOdds], function(err, result){
            if(err){
              console.log(err);
            }else{

            }
          })
          io.emit('matchClosed', result.rows[0])
        }
      })
    })
  socket.on('closeMatch', function(data){
    io.emit('remaining_time', {remaining_time: 0})
      console.log("Ending Betting")
        var queryString = "update test.match set remaining_time = 0, active = false where id = $1 returning *"
        client.query(queryString, [data.match_id], function(err, result){
          if(err){
            console.log(err)
          }else{
            io.emit('bettingClosed', result.rows[0])
          }
        })
        if(interval){
          clearInterval(interval);
        }
  })
  socket.on('saveNewMatch', function(data){
    var queryString = "insert into test.match (active, remaining_time, players, game, totals, odds) values ($1, $2, $3, $4, ARRAY[0,0], ARRAY[1,1]) returning id";
    client.query(queryString, [data.active, data.remaining_time, data.players, data.game], function(err, result){
      if(err){
        console.log(err)
      }else{
        var gameObject = {
          id: result.rows[0]['id'],
          remaining_time: data.remaining_time,
          active: data.active,
          players: data.players,
          game: data.game
        }
        console.log(gameObject)
        io.emit('startNewMatch', gameObject)
        if(typeof interval !== 'undefined'){
          clearInterval(interval);
        }
        interval = setInterval(countDown, 1000, gameObject);
      }
    })
  })

  socket.on('askUserInfo', function(data){
    var queryString = "select * from test.users where id = $1";
    client.query(queryString, [data.user],function(err, result){
      socket.emit('sendUserInfo',{user:result.rows})
    })
  })
  socket.on('my other event', function (data) {
    console.log("Wow")
    console.log(data)
    var queryString = "insert into test.bets (user_id, amount, match_id, player_id) values ($1, $2, $3, $4)"
    client.query(queryString, data.betData, function(err, result){
      var queryString = "select username, amount, player_id from test.bets b join test.match m on b.match_id = m.id join test.users u on b.user_id = u.id where match_id = $1 and player_id = $2 order by b.id desc";
      client.query(queryString, [data.betData[2], data.betData[3]],function(err, result){
        io.emit('news',{bets:result.rows});
        var queryString = "update test.users set money = money - $1 where id = $2 returning money"
        client.query(queryString, [data.betData[1], data.betData[0]], function(err, result){
          if(err){
            console.log(err)
          }else{
            console.log("Money Updated")
            socket.emit('updatedMoney',{
              money:result.rows[0]['money']
            })
            queryString = "update test.match set totals[$1] = case when totals[$1] is NULL then $2 else totals[$1] + $2 end where id = $3 returning *"
            client.query(queryString, [data.betData[3], data.betData[1], data.betData[2]], function(err, result){
              if(err){
                console.log(err)
              }else{
                var queryString = "update test.match set odds[1] = round((totals[1]/(case when least(totals[1], totals[2]) = cast(0 as numeric) then 1 else least(totals[1], totals[2]) end)),2), odds[2] = round((totals[2]/(case when least(totals[1], totals[2]) = cast(0 as numeric) then 1 else least(totals[1], totals[2]) end)),2) where id = $1 returning *"
                client.query(queryString, [data.betData[2]], function(err, result){
                  if(err){
                    console.log(err)
                  }else{
                    io.emit('updatedTotals', result.rows[0])
                  }
                })
                //var player1Odds = Math.round((player1TotalBets/Math.min(player1TotalBets, player2TotalBets)) * 100) / 100
              }
            })
          }
        })
      })
    })
  })
  //console.log(socket);
});*/

/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
}
